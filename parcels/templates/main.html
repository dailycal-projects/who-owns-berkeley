{% extends "base.html" %}

{% load static from staticfiles %}

{% block title %}{% endblock %}
{% block description %}{% endblock %}
{% block extra-meta %}
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:title" content=""/>
<meta name="twitter:site" content="@dailycal"/>
<meta name="twitter:domain" content="The Daily Californian"/>
<meta name="twitter:image" content=""/>
<meta name="twitter:creator" content="@dailycal"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="" />
<meta property="og:url" content="" />
<meta property="og:type" content="article" />
<meta property="og:description" content="" />
<meta proph4erty="og:image" content="" />
<meta property="og:site_name" content="The Daily Californian"/>
<meta property="article:publisher" content="https://www.facebook.com/dailycal"/>
<meta property="fb:admins" content="877855486"/>
{% endblock %}

{% block content %}
<style>
#map {
    height: 400px;
}

</style>

<div id="map">
<script src="http://d3js.org/topojson.v1.min.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="http://www.sumbera.com/gist/js/leaflet/canvas/L.CanvasTiles.js"></script>
<script src="http://handygeospatial.github.io/mapsites/js/TileLayer.GeoJSON.js"></script>
<script src="http://www.sumbera.com/gist/js/vt/geojson-vt-dev.js"></script>
<script type="text/javascript">

var map = L.map('map', {
  center: [37.8716134,-122.2613259], zoom: 15,
});

var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osm = new L.TileLayer(osmUrl);
//map.addLayer(osm);

var tileOptions = {
    maxZoom: 20,  // max zoom to preserve detail on
    tolerance: 1, // simplification tolerance (higher means simpler)
    extent: 4096, // tile extent (both width and height)
    buffer: 64,   // tile buffer on each side
    debug: 2,      // logging level (0 to disable, 1 or 2)

    indexMaxZoom: 0,        // max zoom in the initial tile index
    indexMaxPoints: 100000, // max number of points per tile in the index
};

var pad = 0;

function drawingOnCanvas(canvasOverlay, params) {

    var bounds = params.bounds;
    params.tilePoint.z = params.zoom;

    var ctx = params.canvas.getContext('2d');
    ctx.globalCompositeOperation = 'source-over';

    console.log('getting tile z' + params.tilePoint.z + '-' + params.tilePoint.x + '-' + params.tilePoint.y);

    var tile = tileIndex.getTile(params.tilePoint.z, params.tilePoint.x, params.tilePoint.y);
    if (!tile) {
        console.log('tile empty');
        return;
    }

    ctx.clearRect(0, 0, params.canvas.width, params.canvas.height);

    var features = tile.features;

    console.log(features);

    ctx.strokeStyle = 'grey';

    for (var i = 0; i < features.length; i++) {
        var feature = features[i],

        ctx.fillStyle = feature.tags.color ? feature.tags.color : 'rgba(255,0,0,0.2)';
        ctx.beginPath();

        for (var j = 0; j < feature.geometry.length; j++) {
            var geom = feature.geometry[j];

            if (type === 1) {
                ctx.arc(geom[0] * ratio + pad, geom[1] * ratio + pad, 2, 0, 2 * Math.PI, false);
                continue;
            }

            for (var k = 0; k < geom.length; k++) {
                var p = geom[k];
                var extent = 4096;
               
                var x = p[0] / extent * 256;
                var y = p[1] / extent * 256;
                if (k) ctx.lineTo(x  + pad, y   + pad);
                else ctx.moveTo(x  + pad, y  + pad);
            }
        }

        if (type === 3 || type === 1) ctx.fill('evenodd');
        ctx.stroke();
    }
};

var tileIndex;

var tileLayer = L.canvasTiles()
    .params({ debug: false, padding: 5 })
    .drawing(drawingOnCanvas)

$.getJSON("{% static 'test.geojson' %}", function(data) {
    tileIndex = geojsonvt(data, tileOptions);
    tileLayer.addTo(map);
});

</script>

{% endblock %}